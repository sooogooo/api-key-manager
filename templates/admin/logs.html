{% extends "admin/base.html" %}

{% block title %}ç³»ç»Ÿæ—¥å¿—{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow-sm">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“ ç³»ç»Ÿæ—¥å¿—</h5>
            <div class="d-flex gap-2">
                <!-- æ—¥å¿—çº§åˆ«è¿‡æ»¤ -->
                <select class="form-select form-select-sm" id="levelFilter" onchange="updateFilters()">
                    <option value="all" {{ 'selected' if level == 'all' }}>æ‰€æœ‰çº§åˆ«</option>
                    <option value="INFO" {{ 'selected' if level == 'INFO' }}>ä¿¡æ¯</option>
                    <option value="WARNING" {{ 'selected' if level == 'WARNING' }}>è­¦å‘Š</option>
                    <option value="ERROR" {{ 'selected' if level == 'ERROR' }}>é”™è¯¯</option>
                </select>
                
                <!-- æ¥æºè¿‡æ»¤ -->
                <select class="form-select form-select-sm" id="sourceFilter" onchange="updateFilters()">
                    <option value="all" {{ 'selected' if source == 'all' }}>æ‰€æœ‰æ¥æº</option>
                    {% for src in sources %}
                    <option value="{{ src }}" {{ 'selected' if source == src }}>{{ src }}</option>
                    {% endfor %}
                </select>
                
                <!-- åˆ·æ–°æŒ‰é’® -->
                <button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
                    <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°
                </button>
            </div>
        </div>
        
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 180px;">æ—¶é—´</th>
                            <th style="width: 100px;">çº§åˆ«</th>
                            <th style="width: 150px;">æ¥æº</th>
                            <th>æ¶ˆæ¯</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for log in logs %}
                        <tr>
                            <td>{{ log.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                {% if log.level == 'ERROR' %}
                                    <span class="badge bg-danger">é”™è¯¯</span>
                                {% elif log.level == 'WARNING' %}
                                    <span class="badge bg-warning text-dark">è­¦å‘Š</span>
                                {% else %}
                                    <span class="badge bg-info">ä¿¡æ¯</span>
                                {% endif %}
                            </td>
                            <td>
                                <span class="badge bg-secondary">{{ log.source or 'æœªçŸ¥' }}</span>
                            </td>
                            <td>
                                {% if log.level == 'ERROR' %}
                                    <span class="text-danger">{{ log.message }}</span>
                                {% elif log.level == 'WARNING' %}
                                    <span class="text-warning">{{ log.message }}</span>
                                {% else %}
                                    {{ log.message }}
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                æš‚æ— æ—¥å¿—è®°å½•
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- åˆ†é¡µ -->
            {% if pagination and pagination.pages > 1 %}
            <nav aria-label="æ—¥å¿—åˆ†é¡µ" class="mt-4">
                <ul class="pagination justify-content-center">
                    <!-- é¦–é¡µ -->
                    <li class="page-item {{ 'disabled' if pagination.page == 1 }}">
                        <a class="page-link" href="{{ url_for('admin.view_logs', page=1, level=level, source=source) }}">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    
                    <!-- ä¸Šä¸€é¡µ -->
                    <li class="page-item {{ 'disabled' if not pagination.has_prev }}">
                        <a class="page-link" href="{{ url_for('admin.view_logs', page=pagination.prev_num, level=level, source=source) }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    
                    <!-- é¡µç  -->
                    {% for page in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
                        {% if page %}
                            <li class="page-item {{ 'active' if page == pagination.page }}">
                                <a class="page-link" href="{{ url_for('admin.view_logs', page=page, level=level, source=source) }}">
                                    {{ page }}
                                </a>
                            </li>
                        {% else %}
                            <li class="page-item disabled">
                                <span class="page-link">...</span>
                            </li>
                        {% endif %}
                    {% endfor %}
                    
                    <!-- ä¸‹ä¸€é¡µ -->
                    <li class="page-item {{ 'disabled' if not pagination.has_next }}">
                        <a class="page-link" href="{{ url_for('admin.view_logs', page=pagination.next_num, level=level, source=source) }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    
                    <!-- æœ«é¡µ -->
                    <li class="page-item {{ 'disabled' if pagination.page == pagination.pages }}">
                        <a class="page-link" href="{{ url_for('admin.view_logs', page=pagination.pages, level=level, source=source) }}">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </div>
    
    <!-- æ—¥å¿—è¯´æ˜ -->
    <div class="card shadow-sm mt-4">
        <div class="card-header">
            <h5 class="mb-0">ğŸ’¡ è¯´æ˜</h5>
        </div>
        <div class="card-body">
            <h6>æ—¥å¿—çº§åˆ«è¯´æ˜ï¼š</h6>
            <ul>
                <li><span class="badge bg-info">ä¿¡æ¯</span> - æ­£å¸¸çš„ç³»ç»Ÿæ“ä½œè®°å½•</li>
                <li><span class="badge bg-warning text-dark">è­¦å‘Š</span> - éœ€è¦æ³¨æ„ä½†ä¸å½±å“ç³»ç»Ÿè¿è¡Œçš„é—®é¢˜</li>
                <li><span class="badge bg-danger">é”™è¯¯</span> - ç³»ç»Ÿé”™è¯¯æˆ–å¼‚å¸¸æƒ…å†µ</li>
            </ul>
            
            <h6 class="mt-3">å¸¸è§æ—¥å¿—æ¥æºï¼š</h6>
            <ul>
                <li><strong>api_key_manager</strong> - APIå¯†é’¥ç®¡ç†ç›¸å…³æ“ä½œ</li>
                <li><strong>auth</strong> - ç”¨æˆ·è®¤è¯ç›¸å…³æ“ä½œ</li>
                <li><strong>rate_limit</strong> - è®¿é—®é¢‘ç‡é™åˆ¶ç›¸å…³</li>
                <li><strong>proxy</strong> - APIä»£ç†è½¬å‘ç›¸å…³</li>
                <li><strong>system</strong> - ç³»ç»Ÿè¿è¡ŒçŠ¶æ€ç›¸å…³</li>
            </ul>
            
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle-fill"></i> æç¤ºï¼š
                <ul class="mb-0">
                    <li>ä½¿ç”¨é¡¶éƒ¨çš„è¿‡æ»¤å™¨å¯ä»¥å¿«é€Ÿæ‰¾åˆ°ç‰¹å®šç±»å‹çš„æ—¥å¿—</li>
                    <li>æ—¥å¿—é»˜è®¤æŒ‰æ—¶é—´å€’åºæ’åˆ—ï¼Œæœ€æ–°çš„è®°å½•æ˜¾ç¤ºåœ¨æœ€å‰é¢</li>
                    <li>æ¯é¡µæ˜¾ç¤º50æ¡è®°å½•ï¼Œå¯ä»¥ä½¿ç”¨åˆ†é¡µå¯¼èˆªæŸ¥çœ‹æ›´å¤š</li>
                </ul>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function updateFilters() {
    const level = document.getElementById('levelFilter').value;
    const source = document.getElementById('sourceFilter').value;
    window.location.href = "{{ url_for('admin.view_logs') }}" + 
        `?level=${level}&source=${source}`;
}

function refreshLogs() {
    window.location.reload();
}

// è‡ªåŠ¨åˆ·æ–°ï¼ˆæ¯60ç§’ï¼‰
let autoRefresh = false;
let refreshInterval;

function toggleAutoRefresh() {
    autoRefresh = !autoRefresh;
    const btn = document.getElementById('autoRefreshBtn');
    
    if (autoRefresh) {
        refreshInterval = setInterval(refreshLogs, 60000);
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-secondary');
        btn.innerHTML = '<i class="bi bi-pause-fill"></i> åœæ­¢è‡ªåŠ¨åˆ·æ–°';
    } else {
        clearInterval(refreshInterval);
        btn.classList.remove('btn-secondary');
        btn.classList.add('btn-outline-secondary');
        btn.innerHTML = '<i class="bi bi-play-fill"></i> è‡ªåŠ¨åˆ·æ–°';
    }
}

// é”™è¯¯æ¶ˆæ¯å±•å¼€/æ”¶èµ·
document.querySelectorAll('.log-message').forEach(message => {
    if (message.scrollHeight > message.clientHeight) {
        const expandBtn = document.createElement('button');
        expandBtn.className = 'btn btn-sm btn-link';
        expandBtn.textContent = 'å±•å¼€';
        expandBtn.onclick = () => {
            if (message.style.maxHeight) {
                message.style.maxHeight = null;
                expandBtn.textContent = 'å±•å¼€';
            } else {
                message.style.maxHeight = 'none';
                expandBtn.textContent = 'æ”¶èµ·';
            }
        };
        message.parentNode.appendChild(expandBtn);
    }
});
</script>
{% endblock %}