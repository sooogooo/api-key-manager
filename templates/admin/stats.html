{% extends "admin/base.html" %}

{% block title %}APIä½¿ç”¨ç»Ÿè®¡{% endblock %}

{% block content %}
<div class="container">
    <div class="card shadow-sm mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">ğŸ“Š APIä½¿ç”¨ç»Ÿè®¡</h5>
            <div class="btn-group">
                <a href="{{ url_for('admin.view_stats', provider='all', days=days) }}" 
                   class="btn btn-sm btn-{{ 'primary' if provider == 'all' else 'outline-primary' }}">
                    æ‰€æœ‰æä¾›å•†
                </a>
                <a href="{{ url_for('admin.view_stats', provider='openai', days=days) }}" 
                   class="btn btn-sm btn-{{ 'primary' if provider == 'openai' else 'outline-primary' }}">
                    OpenAI
                </a>
                <a href="{{ url_for('admin.view_stats', provider='anthropic', days=days) }}" 
                   class="btn btn-sm btn-{{ 'primary' if provider == 'anthropic' else 'outline-primary' }}">
                    Anthropic
                </a>
                <a href="{{ url_for('admin.view_stats', provider='google', days=days) }}" 
                   class="btn btn-sm btn-{{ 'primary' if provider == 'google' else 'outline-primary' }}">
                    Google
                </a>
            </div>
        </div>
        
        <div class="card-body">
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="btn-group float-end">
                        <a href="{{ url_for('admin.view_stats', provider=provider, days=7) }}" 
                           class="btn btn-sm btn-{{ 'secondary' if days == 7 else 'outline-secondary' }}">
                            æœ€è¿‘7å¤©
                        </a>
                        <a href="{{ url_for('admin.view_stats', provider=provider, days=30) }}" 
                           class="btn btn-sm btn-{{ 'secondary' if days == 30 else 'outline-secondary' }}">
                            æœ€è¿‘30å¤©
                        </a>
                        <a href="{{ url_for('admin.view_stats', provider=provider, days=90) }}" 
                           class="btn btn-sm btn-{{ 'secondary' if days == 90 else 'outline-secondary' }}">
                            æœ€è¿‘90å¤©
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- æ€»ä½“ç»Ÿè®¡å¡ç‰‡ -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æ€»è°ƒç”¨æ¬¡æ•°</h6>
                            <h3 class="mb-0" id="totalCalls">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æˆåŠŸè°ƒç”¨æ¬¡æ•°</h6>
                            <h3 class="mb-0" id="successCalls">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">æˆåŠŸç‡</h6>
                            <h3 class="mb-0" id="successRate">0%</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <h6 class="card-title">å¹³å‡å“åº”æ—¶é—´</h6>
                            <h3 class="mb-0" id="avgLatency">0ms</h3>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ä½¿ç”¨è¶‹åŠ¿å›¾ -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">ä½¿ç”¨è¶‹åŠ¿</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="usageChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æä¾›å•†åˆ†å¸ƒå’ŒæˆåŠŸç‡ -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">æä¾›å•†åˆ†å¸ƒ</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="providerChart"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">æˆåŠŸç‡åˆ†å¸ƒ</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="successRateChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- è¯¦ç»†æ•°æ®è¡¨æ ¼ -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">è¯¦ç»†æ•°æ®</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>æ—¥æœŸ</th>
                                    <th>æä¾›å•†</th>
                                    <th>æ€»è°ƒç”¨æ¬¡æ•°</th>
                                    <th>æˆåŠŸè°ƒç”¨æ¬¡æ•°</th>
                                    <th>æˆåŠŸç‡</th>
                                    <th>å¹³å‡å“åº”æ—¶é—´</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for stat in stats %}
                                <tr>
                                    <td>{{ stat.date }}</td>
                                    <td>{{ stat.provider }}</td>
                                    <td>{{ stat.total_calls }}</td>
                                    <td>{{ stat.success_calls }}</td>
                                    <td>
                                        {% if stat.total_calls > 0 %}
                                            {{ "%.2f"|format(stat.success_calls / stat.total_calls * 100) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                    <td>{{ "%.2f"|format(stat.avg_latency) }}s</td>
                                </tr>
                                {% else %}
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-4">
                                        æš‚æ— ç»Ÿè®¡æ•°æ®
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// å‡†å¤‡æ•°æ®
const stats = {{ stats|tojson|safe }};
const dates = [...new Set(stats.map(s => s.date))].sort();
const providers = [...new Set(stats.map(s => s.provider))];

// è®¡ç®—æ€»ä½“ç»Ÿè®¡æ•°æ®
const totalCalls = stats.reduce((sum, s) => sum + s.total_calls, 0);
const successCalls = stats.reduce((sum, s) => sum + s.success_calls, 0);
const successRate = totalCalls > 0 ? (successCalls / totalCalls * 100).toFixed(2) : 0;
const avgLatency = stats.length > 0 ? 
    (stats.reduce((sum, s) => sum + s.avg_latency, 0) / stats.length).toFixed(2) : 0;

// æ›´æ–°ç»Ÿè®¡å¡ç‰‡
document.getElementById('totalCalls').textContent = totalCalls;
document.getElementById('successCalls').textContent = successCalls;
document.getElementById('successRate').textContent = successRate + '%';
document.getElementById('avgLatency').textContent = avgLatency + 's';

// ä½¿ç”¨è¶‹åŠ¿å›¾
const usageData = {};
providers.forEach(provider => {
    usageData[provider] = dates.map(date => {
        const stat = stats.find(s => s.date === date && s.provider === provider);
        return stat ? stat.total_calls : 0;
    });
});

const usageDatasets = providers.map((provider, index) => {
    const colors = [
        'rgb(255, 99, 132)',
        'rgb(54, 162, 235)',
        'rgb(255, 205, 86)',
        'rgb(75, 192, 192)'
    ];
    
    return {
        label: provider,
        data: usageData[provider],
        borderColor: colors[index % colors.length],
        tension: 0.1
    };
});

new Chart(document.getElementById('usageChart'), {
    type: 'line',
    data: {
        labels: dates,
        datasets: usageDatasets
    },
    options: {
        responsive: true,
        plugins: {
            title: {
                display: true,
                text: `æœ€è¿‘${dates.length}å¤©ä½¿ç”¨è¶‹åŠ¿`
            }
        }
    }
});

// æä¾›å•†åˆ†å¸ƒå›¾
const providerTotals = providers.map(provider => 
    stats.reduce((sum, s) => sum + (s.provider === provider ? s.total_calls : 0), 0)
);

new Chart(document.getElementById('providerChart'), {
    type: 'doughnut',
    data: {
        labels: providers,
        datasets: [{
            data: providerTotals,
            backgroundColor: [
                'rgb(255, 99, 132)',
                'rgb(54, 162, 235)',
                'rgb(255, 205, 86)',
                'rgb(75, 192, 192)'
            ]
        }]
    }
});

// æˆåŠŸç‡å›¾
const providerSuccess = providers.map(provider => {
    const providerStats = stats.filter(s => s.provider === provider);
    const total = providerStats.reduce((sum, s) => sum + s.total_calls, 0);
    const success = providerStats.reduce((sum, s) => sum + s.success_calls, 0);
    return total > 0 ? (success / total * 100).toFixed(2) : 0;
});

new Chart(document.getElementById('successRateChart'), {
    type: 'bar',
    data: {
        labels: providers,
        datasets: [{
            label: 'æˆåŠŸç‡ (%)',
            data: providerSuccess,
            backgroundColor: [
                'rgba(75, 192, 192, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(75, 192, 192, 0.6)',
                'rgba(75, 192, 192, 0.6)'
            ]
        }]
    },
    options: {
        scales: {
            y: {
                beginAtZero: true,
                max: 100
            }
        }
    }
});
</script>
{% endblock %}